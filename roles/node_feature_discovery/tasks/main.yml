---
- name: Create NFD namespace
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig_path }}"
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ nfd_namespace }}"
        labels:
          openshift.io/cluster-monitoring: "true"

- name: Create OperatorGroup for NFD
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig_path }}"
    state: present
    definition:
      apiVersion: operators.coreos.com/v1
      kind: OperatorGroup
      metadata:
        name: "{{ nfd_operator_name }}"
        namespace: "{{ nfd_namespace }}"
      spec:
        targetNamespaces:
          - "{{ nfd_namespace }}"

- name: Create Subscription for NFD Operator
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig_path }}"
    state: present
    definition:
      apiVersion: operators.coreos.com/v1alpha1
      kind: Subscription
      metadata:
        name: "{{ nfd_operator_name }}"
        namespace: "{{ nfd_namespace }}"
      spec:
        channel: "{{ nfd_channel }}"
        name: nfd
        source: "{{ nfd_source }}"
        sourceNamespace: "{{ nfd_source_namespace }}"
        installPlanApproval: Automatic

- name: Wait for NFD Operator to be ready
  kubernetes.core.k8s_info:
    kubeconfig: "{{ kubeconfig_path }}"
    api_version: apps/v1
    kind: Deployment
    namespace: "{{ nfd_namespace }}"
    label_selectors:
      - control-plane=controller-manager
  register: nfd_deployment
  until:
    - nfd_deployment.resources | length > 0
    - nfd_deployment.resources[0].status.readyReplicas is defined
    - nfd_deployment.resources[0].status.readyReplicas > 0
  retries: 30
  delay: 10

- name: Create NodeFeatureDiscovery instance
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig_path }}"
    state: present
    definition:
      apiVersion: nfd.openshift.io/v1
      kind: NodeFeatureDiscovery
      metadata:
        name: "{{ nfd_instance_name }}"
        namespace: "{{ nfd_namespace }}"
      spec:
        operand:
          imagePullPolicy: IfNotPresent
          servicePort: 12000
        workerConfig:
          configData: |
            core:
              sleepInterval: 60s
            sources:
              pci:
                deviceClassWhitelist:
                  - "0200"
                  - "03"
                  - "12"
                deviceLabelFields:
                  - "vendor"

- name: Wait for NFD master deployment to be ready
  kubernetes.core.k8s_info:
    kubeconfig: "{{ kubeconfig_path }}"
    api_version: apps/v1
    kind: Deployment
    namespace: "{{ nfd_namespace }}"
    label_selectors:
      - app=nfd-master
  register: nfd_master_deployment
  until:
    - nfd_master_deployment.resources | length > 0
    - nfd_master_deployment.resources[0].status.readyReplicas is defined
    - nfd_master_deployment.resources[0].status.readyReplicas > 0
  retries: 30
  delay: 10

- name: Wait for NFD worker pods to be running
  kubernetes.core.k8s_info:
    kubeconfig: "{{ kubeconfig_path }}"
    api_version: v1
    kind: Pod
    namespace: "{{ nfd_namespace }}"
    label_selectors:
      - app=nfd-worker
  register: nfd_worker_pods
  until:
    - nfd_worker_pods.resources | length > 0
    - nfd_worker_pods.resources | selectattr('status.phase', 'equalto', 'Running') | list | length > 0
  retries: 30
  delay: 10

- name: Display NFD deployment status
  ansible.builtin.debug:
    msg: "NFD operator and all components (master, worker) are running successfully"
